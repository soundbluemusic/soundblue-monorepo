#!/bin/sh
# Pre-commit hook: typecheck, lint, and build validation
# ì»¤ë°‹ ì „ ê²€ì¦: íƒ€ì… ì²´í¬, ë¦°íŠ¸, ë¹Œë“œ
#
# ë¹Œë“œ ê±´ë„ˆë›°ë ¤ë©´: SKIP_BUILD=1 git commit -m "message"
# ì „ì²´ ê±´ë„ˆë›°ë ¤ë©´: git commit --no-verify -m "message"

echo "ğŸ” Running pre-commit checks..."

# 1. TypeScript type check
echo "ğŸ“ Type checking..."
pnpm typecheck || exit 1

# 2. Biome lint/format check
echo "ğŸ§¹ Linting..."
pnpm check || exit 1

# 3. Auto-stage routeTree.gen.ts files if modified
# TanStack Routerê°€ ìë™ ìƒì„±í•˜ëŠ” íŒŒì¼ë“¤ - ë¹Œë“œ ì‹œ ë³€ê²½ë  ìˆ˜ ìˆìŒ
ROUTE_FILES=$(git diff --name-only | grep 'routeTree.gen.ts$' || true)
if [ -n "$ROUTE_FILES" ]; then
  echo "ğŸ“¦ Auto-staging routeTree.gen.ts files..."
  echo "$ROUTE_FILES" | xargs git add
fi

# 4. Build all apps (skip with SKIP_BUILD=1)
if [ "$SKIP_BUILD" != "1" ]; then
  echo "ğŸ—ï¸ Building..."
  pnpm build || exit 1

  # 5. Re-stage routeTree.gen.ts after build (may have changed)
  ROUTE_FILES_POST=$(git diff --name-only | grep 'routeTree.gen.ts$' || true)
  if [ -n "$ROUTE_FILES_POST" ]; then
    echo "ğŸ“¦ Auto-staging routeTree.gen.ts files (post-build)..."
    echo "$ROUTE_FILES_POST" | xargs git add
  fi
fi

echo "âœ… All checks passed!"
