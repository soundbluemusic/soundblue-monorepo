import{a as r,p as e}from"./chunk-JMJ3UQ3L-DBUlYMbz.js";import{g as j,r as Q,S as O,P as z,a as J,R as W}from"./audio-context-BaDSkjUw.js";import{u as Y}from"./index-JNvSJHQl.js";const D={bpm:120,beatsPerMeasure:4,beatUnit:4,volume:80,timerMinutes:"",timerSeconds:""},g={MIN:40,MAX:240},L={ACCENT:2e3,REGULAR:800},w={SCHEDULER_INTERVAL_MS:25,LOOK_AHEAD_SECONDS:.1,CLICK_DURATION_SECONDS:.08};function te({settings:y,onSettingsChange:S}){const{t:x}=Y(),[C,B]=r.useState(D),t=r.useMemo(()=>({...D,...y,...C}),[y,C]),b=r.useCallback(s=>{B(n=>({...n,...s})),S?.(s)},[S]),[o,A]=r.useState(!1),[F,T]=r.useState(0),[U,I]=r.useState(0),[M,R]=r.useState(0),[d,k]=r.useState(0),h=r.useRef(null),c=r.useRef(null),p=r.useRef(0),v=r.useRef(0),N=r.useRef(0),V=r.useCallback(s=>{b({bpm:s})},[b]),E=r.useCallback((s,n)=>{try{const a=j(),l=n===0,i=a.createOscillator(),m=a.createGain();i.connect(m),m.connect(a.destination);const f=t.volume/100;l?(i.frequency.value=L.ACCENT,m.gain.setValueAtTime(.8*f,s)):(i.frequency.value=L.REGULAR,m.gain.setValueAtTime(.4*f,s)),m.gain.exponentialRampToValueAtTime(Math.max(.001,.01*f),s+w.CLICK_DURATION_SECONDS),i.start(s),i.stop(s+w.CLICK_DURATION_SECONDS)}catch(a){console.error("[Metronome] Audio playback failed:",a)}},[t.volume]),u=r.useCallback(()=>{A(!1),h.current&&(clearInterval(h.current),h.current=null),c.current&&(cancelAnimationFrame(c.current),c.current=null)},[]),q=r.useCallback(async()=>{if(o)u();else try{await Q();const s=j(),n=Number.parseInt(t.timerMinutes,10)||0,a=Number.parseInt(t.timerSeconds,10)||0,l=(n*60+a)*1e3;l>0&&k(l),N.current=s.currentTime,p.current=s.currentTime,v.current=0,A(!0)}catch(s){console.error("[Metronome] Failed to start audio:",s)}},[o,u,t.timerMinutes,t.timerSeconds]);r.useEffect(()=>{if(!o)return;const s=()=>{try{const n=j();if(N.current===0){c.current=requestAnimationFrame(s);return}const a=n.currentTime,l=60/t.bpm,i=a-N.current,m=i/l,f=Math.floor(m)%t.beatsPerMeasure,X=Math.floor(m/t.beatsPerMeasure)+1;T(f),I(X);const _=i*1e3;if(R(_),d>0&&_>=d){u();return}c.current=requestAnimationFrame(s)}catch(n){console.error("[Metronome] Animation error:",n),u()}};return c.current=requestAnimationFrame(s),()=>{c.current&&cancelAnimationFrame(c.current)}},[o,t.bpm,t.beatsPerMeasure,d,u]),r.useEffect(()=>{if(!o)return;const s=()=>{try{const n=j(),a=60/t.bpm;for(;p.current<n.currentTime+w.LOOK_AHEAD_SECONDS;)E(p.current,v.current),p.current+=a,v.current=(v.current+1)%t.beatsPerMeasure}catch(n){console.error("[Metronome] Scheduler error:",n)}};return h.current=setInterval(s,w.SCHEDULER_INTERVAL_MS),()=>{h.current&&clearInterval(h.current)}},[o,t.bpm,t.beatsPerMeasure,E]);const G=r.useCallback(()=>{u(),T(0),I(0),R(0),k(0),N.current=0},[u]),P=s=>{const n=Math.floor(s/1e3),a=Math.floor(n/60),l=n%60,i=Math.floor(s%1e3/10);return`${a.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}.${i.toString().padStart(2,"0")}`},K=r.useMemo(()=>d>0?Math.max(0,d-M):0,[d,M]),$=r.useMemo(()=>Array.from({length:t.beatsPerMeasure}),[t.beatsPerMeasure]),H=[2,3,4,5,6,7,8,9,12];return e.jsxs("div",{className:"flex h-full flex-col gap-3 overflow-auto p-3 sm:gap-4 sm:p-4",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-card p-4 shadow-sm sm:p-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-5xl font-bold tabular-nums tracking-tight sm:text-7xl",children:t.bpm}),e.jsx("div",{className:"mt-1 text-sm text-muted-foreground",children:"BPM"})]}),e.jsxs("div",{className:"mt-6 px-2",children:[e.jsx(O,{value:[t.bpm],onValueChange:s=>V(s[0]??g.MIN),min:g.MIN,max:g.MAX,step:1}),e.jsxs("div",{className:"mt-2 flex justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:g.MIN}),e.jsx("span",{children:g.MAX})]})]}),e.jsx("div",{className:"mt-6 flex flex-wrap items-center justify-center gap-2 sm:gap-3",children:$.map((s,n)=>e.jsx("div",{className:`h-4 w-4 rounded-full border-2 transition-all duration-100 sm:h-5 sm:w-5 ${o&&n===F?n===0?"scale-125 border-red-500 bg-red-500 shadow-lg shadow-red-500/50":"scale-110 border-primary bg-primary shadow-lg shadow-primary/50":n===0?"border-red-300 bg-red-100 dark:border-red-400/50 dark:bg-red-500/20":"border-primary/40 bg-primary/20 dark:border-primary/50 dark:bg-primary/20"}`},n))})]}),e.jsx("div",{className:"rounded-2xl border border-border bg-card p-3 shadow-sm sm:p-4",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-around gap-2 text-center",children:[e.jsxs("div",{className:"min-w-15",children:[e.jsx("div",{className:"text-xl font-semibold tabular-nums sm:text-2xl",children:U}),e.jsx("div",{className:"text-xs text-muted-foreground",children:x.metronome.measure})]}),e.jsx("div",{className:"h-8 w-px bg-border sm:h-10"}),e.jsxs("div",{className:"min-w-20",children:[e.jsx("div",{className:"font-mono text-lg tabular-nums sm:text-2xl",children:P(M)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:x.metronome.elapsedTime})]}),d>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-8 w-px bg-border sm:h-10"}),e.jsxs("div",{className:"min-w-20",children:[e.jsx("div",{className:"font-mono text-lg tabular-nums text-primary sm:text-2xl",children:P(K)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:x.metronome.remainingTime})]})]})]})}),e.jsxs("div",{className:"divide-y divide-border rounded-2xl border border-border bg-card shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2.5 sm:px-4 sm:py-3",children:[e.jsx("span",{className:"text-xs font-medium sm:text-sm",children:x.metronome.timeSignature}),e.jsx("select",{value:t.beatsPerMeasure,onChange:s=>b({beatsPerMeasure:Number.parseInt(s.currentTarget.value,10)}),className:"h-8 cursor-pointer rounded-lg border border-border bg-background px-2 text-sm transition-colors hover:bg-black/8 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 disabled:opacity-50 dark:hover:bg-white/12 sm:h-9 sm:px-3",disabled:o,children:H.map(s=>e.jsxs("option",{value:s,children:[s,"/4"]},s))})]}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2.5 sm:px-4 sm:py-3",children:[e.jsx("span",{className:"text-xs font-medium sm:text-sm",children:x.metronome.volume}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("div",{className:"w-20 sm:w-28",children:e.jsx(O,{value:[t.volume],onValueChange:s=>b({volume:s[0]}),min:0,max:100,step:1})}),e.jsx("span",{className:"w-6 text-right text-xs tabular-nums text-muted-foreground sm:w-8 sm:text-sm",children:t.volume})]})]}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2.5 sm:px-4 sm:py-3",children:[e.jsx("span",{className:"text-xs font-medium sm:text-sm",children:x.metronome.timer}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"number",min:"0",max:"99",value:t.timerMinutes,onChange:s=>b({timerMinutes:s.currentTarget.value}),placeholder:"0",className:"h-8 w-10 rounded-lg border border-border bg-background px-1 text-center text-sm transition-colors hover:bg-black/8 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 disabled:opacity-50 dark:hover:bg-white/12 sm:h-9 sm:w-12 sm:px-2",disabled:o}),e.jsx("span",{className:"font-medium text-muted-foreground",children:":"}),e.jsx("input",{type:"number",min:"0",max:"59",value:t.timerSeconds,onChange:s=>b({timerSeconds:s.currentTarget.value}),placeholder:"00",className:"h-8 w-10 rounded-lg border border-border bg-background px-1 text-center text-sm transition-colors hover:bg-black/8 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 disabled:opacity-50 dark:hover:bg-white/12 sm:h-9 sm:w-12 sm:px-2",disabled:o})]})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-3 pt-2 sm:gap-4",children:[e.jsx("button",{type:"button",onClick:q,className:`inline-flex h-14 w-14 items-center justify-center rounded-2xl border-2 text-white shadow-lg transition-all duration-200 hover:scale-105 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 active:scale-95 sm:h-16 sm:w-16 ${o?"border-red-600 bg-red-500 shadow-red-500/30 hover:bg-red-600":"border-primary/80 bg-primary shadow-primary/30 hover:bg-primary/90"}`,children:o?e.jsx(z,{className:"h-6 w-6 sm:h-7 sm:w-7"}):e.jsx(J,{className:"ml-0.5 h-6 w-6 sm:ml-1 sm:h-7 sm:w-7"})}),e.jsx("button",{type:"button",onClick:G,className:"inline-flex h-10 w-10 items-center justify-center rounded-xl border border-border text-muted-foreground transition-all duration-200 hover:bg-black/8 hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 dark:hover:bg-white/12 sm:h-12 sm:w-12",children:e.jsx(W,{className:"h-4 w-4 sm:h-5 sm:w-5"})})]})]})}export{te as M};
