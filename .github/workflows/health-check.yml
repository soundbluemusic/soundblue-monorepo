name: Scheduled Health Check

on:
  # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  schedule:
    - cron: '0 */6 * * *'

  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:

jobs:
  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest

    strategy:
      matrix:
        site:
          - name: sound-blue
            url: https://soundbluemusic.com
          - name: tools
            url: https://tools.soundbluemusic.com
          - name: dialogue
            url: https://dialogue.soundbluemusic.com
      fail-fast: false

    steps:
      - name: Check ${{ matrix.site.name }}
        id: health
        run: |
          echo "ğŸ” Checking ${{ matrix.site.url }}"

          # 1. HTTP ìƒíƒœ í™•ì¸
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${{ matrix.site.url }}")
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          if [ "$STATUS" != "200" ]; then
            echo "âŒ HTTP $STATUS"
            exit 1
          fi
          echo "âœ… HTTP 200 OK"

          # 2. ì‘ë‹µ ì‹œê°„ í™•ì¸ (5ì´ˆ ì´ë‚´)
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" --max-time 30 "${{ matrix.site.url }}")
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT

          # 5ì´ˆ ì´ˆê³¼ ì‹œ ê²½ê³  (ì‹¤íŒ¨ëŠ” ì•„ë‹˜)
          if (( $(echo "$RESPONSE_TIME > 5" | bc -l) )); then
            echo "âš ï¸ Slow response: ${RESPONSE_TIME}s"
          else
            echo "âœ… Response time: ${RESPONSE_TIME}s"
          fi

          # 3. HTML ìœ íš¨ì„± í™•ì¸
          HTML=$(curl -s --max-time 30 "${{ matrix.site.url }}")
          HTML_LENGTH=${#HTML}
          echo "html_length=$HTML_LENGTH" >> $GITHUB_OUTPUT

          if [ $HTML_LENGTH -lt 1000 ]; then
            echo "âŒ HTML too short ($HTML_LENGTH bytes)"
            exit 1
          fi
          echo "âœ… HTML length: $HTML_LENGTH bytes"

          # 4. SSR í™•ì¸ (ë¹ˆ root divê°€ ì•„ë‹Œì§€)
          if echo "$HTML" | grep -q '<div id="root"></div>'; then
            echo "âŒ SPA mode detected (empty root div)"
            exit 1
          fi
          echo "âœ… SSR verified"

          # 5. í•„ìˆ˜ íƒœê·¸ í™•ì¸
          if ! echo "$HTML" | grep -q '</html>'; then
            echo "âŒ Invalid HTML (missing </html>)"
            exit 1
          fi
          echo "âœ… Valid HTML structure"

          echo "ğŸ‰ ${{ matrix.site.name }} is healthy!"

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ Health Check Failed: ${{ matrix.site.name }}`;
            const body = `
            ## Health Check Failure

            **Site:** ${{ matrix.site.name }}
            **URL:** ${{ matrix.site.url }}
            **Time:** ${new Date().toISOString()}

            ### Details
            - HTTP Status: ${{ steps.health.outputs.status || 'N/A' }}
            - Response Time: ${{ steps.health.outputs.response_time || 'N/A' }}s
            - HTML Length: ${{ steps.health.outputs.html_length || 'N/A' }} bytes

            ### Action Required
            Please investigate immediately.

            ---
            *This issue was automatically created by Health Check workflow.*
            `;

            // ë™ì¼í•œ ì œëª©ì˜ ì—´ë¦° ì´ìŠˆê°€ ìˆëŠ”ì§€ í™•ì¸
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check'
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['health-check', 'urgent']
              });
            }
