name: Cleanup Old Pages Projects

on:
  workflow_dispatch:

jobs:
  cleanup:
    name: Delete Old Pages Projects
    runs-on: ubuntu-latest
    steps:
      - name: Delete t00ls (Pages)
        run: |
          echo "Deleting deployments for 't00ls'..."
          for i in {1..50}; do
            RESPONSE=$(curl -s -X GET \
              "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/t00ls/deployments?per_page=25" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json")

            DEPLOYMENTS=$(echo "$RESPONSE" | jq -r '.result[]?.id // empty' 2>/dev/null || echo "")

            if [ -z "$DEPLOYMENTS" ]; then
              echo "No more deployments for 't00ls'"
              break
            fi

            for id in $DEPLOYMENTS; do
              echo "Deleting deployment $id..."
              curl -s -X DELETE \
                "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/t00ls/deployments/$id?force=true" \
                -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
                -H "Content-Type: application/json" > /dev/null
            done
          done

          echo "Deleting 't00ls' project..."
          curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/t00ls" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json"
          echo "Done with t00ls"

      - name: Delete soundbluemusic (Pages)
        run: |
          echo "Deleting deployments for 'soundbluemusic'..."
          for i in {1..50}; do
            RESPONSE=$(curl -s -X GET \
              "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/soundbluemusic/deployments?per_page=25" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json")

            DEPLOYMENTS=$(echo "$RESPONSE" | jq -r '.result[]?.id // empty' 2>/dev/null || echo "")

            if [ -z "$DEPLOYMENTS" ]; then
              echo "No more deployments for 'soundbluemusic'"
              break
            fi

            for id in $DEPLOYMENTS; do
              echo "Deleting deployment $id..."
              curl -s -X DELETE \
                "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/soundbluemusic/deployments/$id?force=true" \
                -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
                -H "Content-Type: application/json" > /dev/null
            done
          done

          echo "Deleting 'soundbluemusic' project..."
          curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/soundbluemusic" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json"
          echo "Done with soundbluemusic"

      - name: Delete dial0gue (Pages)
        run: |
          echo "Deleting deployments for 'dial0gue'..."
          for i in {1..50}; do
            RESPONSE=$(curl -s -X GET \
              "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/dial0gue/deployments?per_page=25" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json")

            DEPLOYMENTS=$(echo "$RESPONSE" | jq -r '.result[]?.id // empty' 2>/dev/null || echo "")

            if [ -z "$DEPLOYMENTS" ]; then
              echo "No more deployments for 'dial0gue'"
              break
            fi

            for id in $DEPLOYMENTS; do
              echo "Deleting deployment $id..."
              curl -s -X DELETE \
                "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/dial0gue/deployments/$id?force=true" \
                -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
                -H "Content-Type: application/json" > /dev/null
            done
          done

          echo "Deleting 'dial0gue' project..."
          curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/dial0gue" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json"
          echo "Done with dial0gue"

      - name: Verify deletion
        run: |
          echo "Remaining Pages projects:"
          curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" | jq -r '.result[].name // "None"'
