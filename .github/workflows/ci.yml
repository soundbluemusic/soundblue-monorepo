name: Quality Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# ê°™ì€ workflow ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ - ìƒˆ ì»¤ë°‹ ì˜¤ë©´ ì´ì „ ì‹¤í–‰ ì·¨ì†Œ
concurrency:
  group: quality-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # Stage 1: ë¹ ë¥¸ ê²€ì¦ (ë¹Œë“œ ë¶ˆí•„ìš”)
  # ============================================================
  fast-checks:
    name: Fast Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-
            turbo-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm turbo build --filter="@soundblue/*"

      - name: Generate paraglide (i18n)
        run: |
          pnpm --filter sound-blue exec paraglide-js compile --project ./project.inlang --outdir ./app/paraglide &
          pnpm --filter tools exec paraglide-js compile --project ./project.inlang --outdir ./app/paraglide &
          pnpm --filter dialogue exec paraglide-js compile --project ./project.inlang --outdir ./app/paraglide &
          wait

      - name: TypeScript check
        run: pnpm typecheck

      - name: Lint
        run: pnpm check

      - name: Test with coverage
        run: pnpm test

      - name: Check circular dependencies
        run: pnpm check:circular

      - name: Dependency audit (security)
        run: pnpm audit --audit-level=high
        continue-on-error: true

  # ============================================================
  # Stage 2: ë¹Œë“œ (í•œ ë²ˆë§Œ ì‹¤í–‰, artifactë¡œ ê³µìœ )
  # ============================================================
  build:
    name: Build All Apps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-
            turbo-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all apps
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            apps/sound-blue/dist
            apps/tools/dist
            apps/dialogue/dist
          retention-days: 1

  # ============================================================
  # Stage 3: ë¹Œë“œ ê²°ê³¼ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ë“¤ (ë³‘ë ¬ ì‹¤í–‰)
  # ============================================================

  # Job 3-1: ëª¨ë“  Playwright í…ŒìŠ¤íŠ¸ (í†µí•©)
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: apps

      - name: Fix artifact paths
        run: |
          for app in sound-blue tools dialogue; do
            if [ -d "apps/$app/$app/dist" ]; then
              mv apps/$app/$app/dist apps/$app/dist
              rmdir apps/$app/$app 2>/dev/null || true
            fi
          done

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Run all E2E tests
        run: pnpm exec playwright test tests/e2e/

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # Job 3-2: Lighthouse CI
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: apps

      - name: Fix artifact paths
        run: |
          for app in sound-blue tools dialogue; do
            if [ -d "apps/$app/$app/dist" ]; then
              mv apps/$app/$app/dist apps/$app/dist
              rmdir apps/$app/$app 2>/dev/null || true
            fi
          done

      - name: Install Chrome for Lighthouse
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
        id: setup-chrome

      - name: Set Chrome path
        run: echo "CHROME_PATH=${{ steps.setup-chrome.outputs.chrome-path }}" >> $GITHUB_ENV

      - name: Run Lighthouse CI
        run: pnpm lhci autorun

  # Job 3-3: ë¹Œë“œ í›„ ê²€ì¦
  post-build:
    name: Post Build Checks
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: apps

      - name: Fix artifact paths
        run: |
          for app in sound-blue tools dialogue; do
            if [ -d "apps/$app/$app/dist" ]; then
              mv apps/$app/$app/dist apps/$app/dist
              rmdir apps/$app/$app 2>/dev/null || true
            fi
          done

      - name: Check bundle size
        run: pnpm check:size

      - name: Verify SSR build
        run: pnpm verify:ssr

      - name: Run SEO build tests (dialogue)
        run: pnpm --filter dialogue exec vitest run tests/seo-build/

  # ============================================================
  # Stage 4: ë°°í¬ (main pushì—ë§Œ, ëª¨ë“  ê²€ì¦ í†µê³¼ í›„)
  # ============================================================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [fast-checks, e2e-tests, lighthouse, post-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      matrix:
        app: [sound-blue, tools, dialogue]
      fail-fast: false
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: apps

      - name: Fix artifact paths
        run: |
          for app in sound-blue tools dialogue; do
            if [ -d "apps/$app/$app/dist" ]; then
              mv apps/$app/$app/dist apps/$app/dist
              rmdir apps/$app/$app 2>/dev/null || true
            fi
          done

      - name: Verify artifacts
        run: ls -la apps/${{ matrix.app }}/dist/

      - name: Deploy ${{ matrix.app }}
        working-directory: apps/${{ matrix.app }}
        run: pnpm exec wrangler deploy --config dist/server/wrangler.json

      - name: Purge Cloudflare cache
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'

      - name: Wait for cache propagation
        run: sleep 10

      - name: Smoke test - Production URL
        run: |
          # ì•±ë³„ í”„ë¡œë•ì…˜ URL ë§¤í•‘
          case "${{ matrix.app }}" in
            sound-blue) URL="https://soundbluemusic.com" ;;
            tools) URL="https://tools.soundbluemusic.com" ;;
            dialogue) URL="https://dialogue.soundbluemusic.com" ;;
          esac

          echo "ğŸ” Testing $URL"

          # 1. HTTP ìƒíƒœ í™•ì¸
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ HTTP status $STATUS (expected 200)"
            exit 1
          fi
          echo "âœ… HTTP 200 OK"

          # 2. HTML ì‘ë‹µ í™•ì¸ (ë¹ˆ í˜ì´ì§€ê°€ ì•„ë‹Œì§€)
          HTML=$(curl -s "$URL")
          if [ ${#HTML} -lt 1000 ]; then
            echo "âŒ HTML too short (${#HTML} bytes) - possible empty page"
            exit 1
          fi
          echo "âœ… HTML response: ${#HTML} bytes"

          # 3. í•„ìˆ˜ ìš”ì†Œ í™•ì¸ (SSR ê²€ì¦)
          if ! echo "$HTML" | grep -q "</html>"; then
            echo "âŒ Missing </html> tag"
            exit 1
          fi
          echo "âœ… Valid HTML structure"

          # 4. SPA ì•„ë‹Œì§€ í™•ì¸ (ë¹ˆ body ì²´í¬)
          if echo "$HTML" | grep -q '<div id="root"></div>'; then
            echo "âš ï¸ Warning: Possible SPA mode detected (empty root div)"
          fi

          # 5. ì£¼ìš” ìì‚° ë¡œë“œ í™•ì¸
          if echo "$HTML" | grep -qE '(\.js"|\.css")'; then
            echo "âœ… Assets referenced in HTML"
          fi

          echo "ğŸ‰ Smoke test passed for ${{ matrix.app }}"
