name: Quality Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Í∞ôÏùÄ workflow Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ - ÏÉà Ïª§Î∞ã Ïò§Î©¥ Ïù¥Ï†Ñ Ïã§Ìñâ Ï∑®ÏÜå
concurrency:
  group: quality-gate-${{ github.ref }}
  cancel-in-progress: true

env:
  # Turbo Remote Cache (Vercel)
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  # ============================================================
  # Stage 1: ÏÑ§Ïπò + ÎπåÎìú + Îπ†Î•∏ Í≤ÄÏ¶ù (ÌÜµÌï©)
  # ============================================================
  build-and-check:
    name: Build & Check
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-keys.outputs.modules }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Generate cache keys
        id: cache-keys
        run: |
          echo "modules=node-modules-${{ hashFiles('pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT
          echo "turbo=turbo-${{ github.sha }}" >> $GITHUB_OUTPUT

      # 1. node_modules Ï∫êÏãú (Ï†ÑÏ≤¥ ÏõåÌÅ¨ÌîåÎ°úÏö∞ÏóêÏÑú Í≥µÏú†)
      - name: Cache node_modules
        id: cache-modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/*/node_modules
          key: ${{ steps.cache-keys.outputs.modules }}
          restore-keys: |
            node-modules-

      - name: Install dependencies
        if: steps.cache-modules.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile

      # pnpm storeÎèÑ Ï∫êÏãú (install Ïãú ÌïÑÏöî)
      - name: Setup pnpm store
        if: steps.cache-modules.outputs.cache-hit != 'true'
        run: pnpm store prune

      # 2. Turbo Ï∫êÏãú (Î°úÏª¨ + Î¶¨Î™®Ìä∏)
      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ steps.cache-keys.outputs.turbo }}
          restore-keys: |
            turbo-

      # ÎπåÎìú Ï†Ñ Ï§ÄÎπÑ (paraglide Îì±)
      - name: Generate paraglide (i18n)
        run: |
          pnpm --filter sound-blue exec paraglide-js compile --project ./project.inlang --outdir ./app/paraglide &
          pnpm --filter tools exec paraglide-js compile --project ./project.inlang --outdir ./app/paraglide &
          pnpm --filter dialogue exec paraglide-js compile --project ./project.inlang --outdir ./app/paraglide &
          wait

      # Ï†ÑÏ≤¥ ÎπåÎìú (packages + apps) - Turbo Remote Cache ÌôúÏö©
      - name: Build all
        run: pnpm build

      # Îπ†Î•∏ Í≤ÄÏ¶ùÎì§ (ÎπåÎìú ÌõÑ Ïã§Ìñâ)
      - name: TypeScript check
        run: pnpm typecheck

      - name: Lint
        run: pnpm check

      - name: Test with coverage
        run: pnpm test

      - name: Check circular dependencies
        run: pnpm check:circular

      - name: Check React patterns
        run: pnpm check:react-patterns

      - name: Dependency audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      # ÎπåÎìú Í≤∞Í≥ºÎ¨º ÏóÖÎ°úÎìú
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            apps/sound-blue/dist
            apps/tools/dist
            apps/dialogue/dist
          retention-days: 1

  # ============================================================
  # Stage 2: ÎπåÎìú Í≤∞Í≥º ÏÇ¨Ïö©ÌïòÎäî ÌÖåÏä§Ìä∏Îì§ (Î≥ëÎ†¨ Ïã§Ìñâ)
  # ============================================================

  # E2E ÌÖåÏä§Ìä∏
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build-and-check
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # Ï∫êÏãúÎêú node_modules Î≥µÏõê
      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/*/node_modules
          key: ${{ needs.build-and-check.outputs.cache-key }}

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-output
          path: apps

      - name: Fix artifact paths
        run: bash scripts/fix-artifact-paths.sh

      # Playwright Ï∫êÏãú
      - name: Cache Playwright
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Run E2E tests
        run: pnpm exec playwright test tests/e2e/

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # Lighthouse CI
  lighthouse:
    name: Lighthouse
    runs-on: ubuntu-latest
    needs: build-and-check
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/*/node_modules
          key: ${{ needs.build-and-check.outputs.cache-key }}

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-output
          path: apps

      - name: Fix artifact paths
        run: bash scripts/fix-artifact-paths.sh

      - name: Install Chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
        id: setup-chrome

      - name: Set Chrome path
        run: echo "CHROME_PATH=${{ steps.setup-chrome.outputs.chrome-path }}" >> $GITHUB_ENV

      - name: Run Lighthouse CI
        run: pnpm lhci autorun

  # ÎπåÎìú ÌõÑ Í≤ÄÏ¶ù
  post-build:
    name: Post Build
    runs-on: ubuntu-latest
    needs: build-and-check
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/*/node_modules
          key: ${{ needs.build-and-check.outputs.cache-key }}

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-output
          path: apps

      - name: Fix artifact paths
        run: bash scripts/fix-artifact-paths.sh

      - name: Check bundle size
        run: pnpm check:size

      - name: Verify SSR build
        run: pnpm verify:ssr

      - name: Run SEO build tests
        run: |
          pnpm --filter dialogue exec vitest run tests/seo-build/
          pnpm --filter tools exec vitest run tests/seo-build/

  # ============================================================
  # Stage 3: Î∞∞Ìè¨ (main pushÏóêÎßå, Î™®Îì† Í≤ÄÏ¶ù ÌÜµÍ≥º ÌõÑ)
  # ============================================================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [build-and-check, e2e-tests, lighthouse, post-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      matrix:
        app: [sound-blue, tools, dialogue]
      fail-fast: false
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # Ï∫êÏãúÎêú node_modules Î≥µÏõê (install Î∂àÌïÑÏöî)
      - name: Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/*/node_modules
          key: ${{ needs.build-and-check.outputs.cache-key }}

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-output
          path: apps

      - name: Fix artifact paths
        run: bash scripts/fix-artifact-paths.sh

      - name: Verify artifacts
        run: ls -la apps/${{ matrix.app }}/dist/

      - name: Deploy ${{ matrix.app }}
        working-directory: apps/${{ matrix.app }}
        run: pnpm exec wrangler deploy --config dist/server/wrangler.json

      - name: Purge Cloudflare cache
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'

      - name: Wait for propagation
        run: sleep 10

      - name: Smoke test
        run: |
          case "${{ matrix.app }}" in
            sound-blue) URL="https://soundbluemusic.com" ;;
            tools) URL="https://tools.soundbluemusic.com" ;;
            dialogue) URL="https://dialogue.soundbluemusic.com" ;;
          esac

          echo "üîç Testing $URL"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå HTTP status $STATUS"
            exit 1
          fi
          echo "‚úÖ HTTP 200 OK"

          HTML=$(curl -s "$URL")
          if [ ${#HTML} -lt 1000 ]; then
            echo "‚ùå HTML too short"
            exit 1
          fi
          echo "‚úÖ HTML: ${#HTML} bytes"

          if ! echo "$HTML" | grep -q "</html>"; then
            echo "‚ùå Invalid HTML"
            exit 1
          fi
          echo "‚úÖ Valid HTML"

          echo "üéâ ${{ matrix.app }} deployed!"
